% filename: arholiad.sty
%
% This is ripped-off exam.cls, with the page numbering and points
% stuff taken out. The purpose is to provide structured format for 
% exercises, questions and solutions, to make it easier for the parser.
\NeedsTeXFormat{LaTeX2e}
\def\fileversion{1.0}
\def\filedate{2014/08/28}
\ProvidesPackage{arholiad}[\filedate \space v\fileversion \space (de)]
\ProvidesFile{arholiad.sty}[\filedate \space v\fileversion \space (de)]

\newif\ifprintanswers
\printanswersfalse
\DeclareOption{answers}{\printanswerstrue}
\DeclareOption{noanswers}{\printanswersfalse}

\newif\ifprintanswersatend
\printanswersatendfalse
\DeclareOption{answersatend}{\printanswersatendtrue}
\DeclareOption{noanswersatend}{\printanswersatendfalse}

\ProcessOptions
\relax

% printanswers commands (don't use these!!)
\def\printanswers{\printanswerstrue}
\def\printanswersatend{\printanswersatendtrue}

% names
\newcommand{\exercisename}{Exercise}
\newcommand{\questionname}{Question}
\newcommand{\answername}{Answer}

% open answers file at begin document
\AtBeginDocument{
    \ifx\@undefined\@ansout\newwrite\@ansout\fi
    \immediate\openout\@ansout=\jobname.ans
}
% close and process input answers file at end document
\AtEndDocument{
	\immediate\closeout\@ansout
    \newpage
    \appendix
    \chapter{Answers}
	\renewcommand{\labelenumi}{\arabic{enumi}.}
	\renewcommand{\labelenumii}{(\alph{enumii})}
	\renewcommand{\labelenumiii}{(\roman{enumiii})}
	\renewcommand{\labelenumiv}{\alph{enumiv}}
	\input{\jobname.ans}
}
% command to write to answers file
\def\ans@write#1{
    \immediate\write\@ansout{#1}
}

% counters
\newcounter{exercise}[chapter]

% answer 
\RequirePackage{framed}
\newcommand{\answertitle}{\noindent\textbf{\answername:}\enspace}
\RequirePackage{environ}
\NewEnviron{answer}{%
    \ifprintanswers
        \vspace{\parskip}
        \begin{framed}
        \answertitle
        \BODY
        \end{framed}
    \fi
    \ifprintanswersatend
        \ans@write{\BODY}
    \fi
}{}

% exercise
\RequirePackage{xifthen} % provides \isempty test
\newcommand{\exercisetitle}{}
\newenvironment{exercise}[1][]{%
  \refstepcounter{exercise}
  \ifthenelse{\isempty{#1}}{\renewcommand{\exercisetitle}{}}{\renewcommand{\exercisetitle}{\space[#1]}}
  \renewcommand{\exercisename}{Exercise \thechapter.\theexercise\quad\exercisetitle}
  \par\vspace{2ex}\noindent\textbf{\large\exercisename\normalsize} \par\vspace{1ex}
  \ans@write{\noexpand\subsection*{\exercisename}}
}{}

% diagnostic
\newenvironment{diagnostic}{%
  \begin{exercise}[Diagnositic]
}{
  \end{exercise}
}
% formative 
\newenvironment{formative}{%
  \begin{exercise}[Formative]
}{%
  \end{exercise}
}
% summative
\newenvironment{summative}{%
  \begin{exercise}[Summative]
}{%
  \end{exercise}
}

%------------------------------------------------
% exam.cls rip-off starts here
%------------------------------------------------

% counters
\newcounter{question}
\newcounter{partno}
\newcounter{subpart}
\newcounter{subsubpart}
\newcounter{choice}

% hooks (for user customization)
\newcommand\questionshook{}
\newcommand\partshook{}
\newcommand\subpartshook{}
\newcommand\subsubpartshook{}
\newcommand\choiceshook{}
\newcommand\checkboxeshook{}

%--------------------
% questions
\newenvironment{questions}{%
  \ans@write{\noexpand\begin{enumerate}}
  \def\@queslevel{question}%
  \def\question{%
    \ans@write{\noexpand\item}
    \def\thequestiontitle{\questionname~thequestion}%
    \@checkqueslevel{question}%
    \edef\@queslabel{question.\arabic{chapter}.\arabic{exercise}.\arabic{question}}%
    \gdef\@currentlabel{\@queslabel}%
    \label{\@queslabel}%
    \item
  } % end question
  \def\subpart{%
    \ans@write{\noexpand\item}
    \@checkqueslevel{subpart}%
    \edef\@subpartlabel{subpart.\arabic{question}.\arabic{partno}.\arabic{subpart}}%
    \label{\@subpartlabel}%
    \item
  } % end subpart
  \def\subsubpart{%
    \ans@write{\noexpand\item}
    \@checkqueslevel{subsubpart}%
    \edef\@subsubpartlabel{subsubpart.\arabic{question}.\arabic{partno}.\arabic{subpart}.\arabic{subsubpart}}
    \label{\@subsubpartlabel}%
    \item
  } % end subsubpart 
  \list{\question@number}{%
    \usecounter{question}%
    \settowidth{\leftmargin}{10.\hskip\labelsep}%
    \labelwidth\leftmargin\advance\labelwidth-\labelsep
    \partopsep=0pt
    \questionshook
    }%
}{%
	\endlist
	\ans@write{\noexpand\end{enumerate}}
}% end questions environment
  
\def\question@number{\questionlabel}
\newcommand\questionlabel{\thequestion.}

%--------------------
% parts
\newenvironment{parts}{%
	\ans@write{\noexpand\begin{enumerate}}
	\def\@queslevel{part}%
	\def\part{%
    	\ans@write{\noexpand\item}
    	\@checkqueslevel{part}%
    	\edef\@partlabel{part.\arabic{chapter}.\arabic{exercise}.\arabic{question}.\arabic{partno}}%
    	\label{\@partlabel}%
    	\item
	} % end part
	\list{\partlabel}{%
    	\usecounter{partno}\def\makelabel##1{\hss\llap{##1}}%
    	\settowidth{\leftmargin}{(m)\hskip\labelsep}%
    	\labelwidth\leftmargin\advance\labelwidth-\labelsep
    	\topsep=0pt
    	\partopsep=0pt
    	\partshook
	}%
}{%
	\endlist
	\ans@write{\noexpand\end{enumerate}}
} % end parts environmen

\newcommand\partlabel{\thepartno}
\def\thepartno{(\alph{partno})}

%--------------------
% subparts
\newenvironment{subparts}{%
	\ans@write{\noexpand\begin{enumerate}}
	\def\@queslevel{subpart}%
	\list{\subpartlabel}{%
    	\usecounter{subpart}\def\makelabel##1{\hss\llap{##1}}%
    	\settowidth{\leftmargin}{vii.\hskip\labelsep}%
    	\labelwidth\leftmargin\advance\labelwidth-\labelsep
    	\topsep=0pt
    	\partopsep=0pt
    	\subpartshook
    }%
}{%
	\endlist 
	\ans@write{\noexpand\end{enumerate}}
}

\newcommand\subpartlabel{\thesubpart.}
\def\thesubpart{(\roman{subpart})}

%--------------------
% subsubparts
\newenvironment{subsubparts}{%
	\ans@write{\noexpand\begin{enumerate}}
	\def\@queslevel{subsubpart}%
	\list{\subsubpartlabel}{%
	    \usecounter{subsubpart}\def\makelabel##1{\hss\llap{##1}}%
    	\settowidth{\leftmargin}{($\psi$)\hskip\labelsep}%
    	\labelwidth\leftmargin\advance\labelwidth-\labelsep
    	\topsep=0pt
    	\partopsep=0pt
    	\subsubpartshook
    }%
}{%
	\endlist 
	\ans@write{\noexpand\end{enumerate}}
}

\newcommand\subsubpartlabel{\thesubsubpart.}
\def\thesubsubpart{\alph{subsubpart}}

%-----------------------
% validation
\def\@checkqueslevel#1{%
  \begingroup
    \def\@temp{#1}%
    \ifx\@temp\@queslevel
      % do nothing.
    \else
      \ClassError{exam}{%
        I found a #1 where I expected to find a \@queslevel
        \MessageBreak
      }{%
        Both #1 and \@queslevel \space can be used only inside the correct 
        \MessageBreak \space \space
        environment and outside of any smaller environment
        \MessageBreak
      }%
    \fi
  \endgroup
}

%-----------------------
% choices
\renewcommand\thechoice{\Alph{choice}.}
\newcommand\choicelabel{\thechoice}
\newif\if@correctchoice
\@correctchoicefalse
\newcommand\CorrectChoiceEmphasis[1]{%
  \def\CorrectChoice@Emphasis{#1}%
}
\CorrectChoiceEmphasis{\bfseries}
\let\correctchoiceemphasis\CorrectChoiceEmphasis

% begin choices
\newenvironment{choices}{%
	\list{\choicelabel}{%
		\usecounter{choice}\def\makelabel##1{\hss\llap{##1}}%
		\settowidth{\leftmargin}{W.\hskip\labelsep}%
       	\def\choice{%
       		\if@correctchoice
           		\endgroup
         	\fi
         	\item
		} % end choice
		\def\CorrectChoice{%
			\if@correctchoice
       			\endgroup
       		\fi
       		\ifprintanswers
				\begingroup 
                \@correctchoicetrue
				\CorrectChoice@Emphasis
			\fi
			\item
			\ifprintanswersatend
        		\ans@write{\thechoice}
			\fi
		} % end CorrectChoice
		\let\correctchoice\CorrectChoice
       	\topsep=2pt
       	\partopsep=0pt
       	\choiceshook
	}
}{%
	\if@correctchoice 
		\endgroup 
	\fi 
	\endlist
} % end choices

%-----------------------
% checkboxes
\RequirePackage{amssymb}
\newcommand{\checkboxchar}[1]{\def\checkbox@char{#1}}
\newcommand{\checkedchar}[1]{\def\checked@char{#1}}
\checkboxchar{$\square$}
\checkedchar{$\checkmark$}

% begin checkboxes
\newenvironment{checkboxes}%
  {\list{\checkbox@char}%
     {\usecounter{choice}%
       \settowidth{\leftmargin}{W.\hskip\labelsep}%
       \def\choice{%
         \if@correctchoice
           \endgroup
         \fi
         \item
       } % choice
       \def\CorrectChoice{%
         \if@correctchoice
           \endgroup
         \fi
         \ifprintanswers
           \begingroup 
           \@correctchoicetrue
           \CorrectChoice@Emphasis
           \item[\checked@char]
         \else
           \item
         \fi
         \ifprintanswersatend
            \ans@write{\thechoice}
         \fi
       } % CorrectChoice
       \let\correctchoice\CorrectChoice
       \topsep=2pt
       \partopsep=0pt
       \checkboxeshook
     }%
}{%
    \if@correctchoice 
        \endgroup 
    \fi 
    \endlist
} % enc checkboxes

%-----------------------
% move up one level
\long\def\uplevel#1{%
  \par\bigskip
  \vbox{%
    \leftskip=\@totalleftmargin
    \advance\leftskip-\leftmargin
    \advance\@totalleftmargin-\leftmargin
    \advance\linewidth\leftmargin
    #1%
  }% vbox
  \nobreak
}

